language: php
php:
- 7.2
- 7.3
- 7.4snapshot

matrix:
  allow_failures:
    - php: 7.4snapshot

services:
- mysql
- memcached
- mongodb
- postgresql

before_install:
- echo "extension = memcached.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
- echo "extension = mongodb.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
- sudo apt-get update
- sudo apt-get --yes remove postgresql\*
- sudo apt-get install -y postgresql-11 postgresql-client-11
- sudo cp /etc/postgresql/{9.6,11}/main/pg_hba.conf
- sudo service postgresql restart 11 

before_script:
- composer install
- psql -U postgres -a -f vendor/linna/db-dumps/src/linna_db_pgsql_test.sql
- mysql -e 'create database linna_db;'
- mysql -u root linna_db < vendor/linna/db-dumps/src/linna_db_mysql_test.sql

git:
  depth: false

script:
- ./vendor/bin/phpunit --coverage-clover=coverage-report.clover --log-junit=test-report.xml
- ./vendor/bin/infection --min-msi=75 --min-covered-msi=75
